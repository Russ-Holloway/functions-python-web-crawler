# v2.7.0 Deployment Summary

## What Changed

### The Problem
Documents were appearing as "Other" in your dashboard even though all documents should be properly categorized by website.

### The Root Cause
Two issues:
1. `.folder` placeholder files were being counted in storage statistics
2. No easy way to clean up old documents without proper folder structure

### The Solution
**v2.7.0 fixes both issues:**

1. ‚úÖ **Enhanced File Filtering** - Excludes `.folder` placeholder files from statistics
2. ‚úÖ **Better Categorization** - Improved logging for uncategorized documents
3. ‚úÖ **NEW: Cleanup Utility** - Tool to delete uncategorized documents

---

## Quick Start: Deploy v2.7.0

### Deployment via GitHub Actions (Automated)

This project uses GitHub Actions for automated deployment:

```bash
# Stage all changes
git add .

# Commit with message
git commit -m "v2.7.0: Fixed 'Other' category issue and added cleanup utility"

# Push to main branch (triggers automatic deployment)
git push origin main
```

**Monitor deployment:** https://github.com/Russ-Holloway/functions-python-web-crawler/actions

**Your Azure Resources:**
- Function App: `func-btp-uks-prod-doc-crawler-01`
- Resource Group: `rg-btp-uks-prod-doc-mon-01`  
- Subscription: `96726562-1726-4984-88c6-2e4f28878873`

### Verify Deployment

```bash
# Set function URL
FUNCTION_URL="func-btp-uks-prod-doc-crawler-01.azurewebsites.net"

# Test dashboard
curl "https://${FUNCTION_URL}/api/dashboard"
```

---

## Quick Start: Clean Up "Other" Documents

### Option A: Simple Approach (Recommended)
```bash
# Check what will be deleted (safe dry run)
curl "https://${FUNCTION_URL}/api/cleanup_uncategorized" | jq .

# Delete uncategorized documents
curl -X POST "https://${FUNCTION_URL}/api/cleanup_uncategorized" \
  -H "Content-Type: application/json" \
  -d '{"dry_run": false}' | jq .

# Wait for next scheduled crawl (every 4 hours) OR trigger manual crawl:
curl -X POST "https://${FUNCTION_URL}/api/manual_crawl" \
  -H "Content-Type: application/json" \
  -d '{"websites": ["all"]}' | jq .
```

### Option B: Let It Fix Naturally
- Deploy v2.7.0
- Wait for next scheduled crawl
- Dashboard will gradually improve as new documents are properly categorized

---

## What You Get

### Before v2.7.0
```
Dashboard:
‚îú‚îÄ‚îÄ Crown Prosecution Service: 50 docs
‚îú‚îÄ‚îÄ College of Policing: 30 docs
‚îî‚îÄ‚îÄ Other: 20 docs ‚ùå <- Problem!
```

### After v2.7.0 (without cleanup)
```
Dashboard:
‚îú‚îÄ‚îÄ Crown Prosecution Service: 50 docs
‚îú‚îÄ‚îÄ College of Policing: 30 docs
‚îî‚îÄ‚îÄ Uncategorized (Legacy): 20 docs ‚ö†Ô∏è <- Properly labeled
```

### After v2.7.0 + Cleanup
```
Dashboard:
‚îú‚îÄ‚îÄ Crown Prosecution Service: 70 docs ‚úÖ
‚îú‚îÄ‚îÄ College of Policing: 50 docs ‚úÖ
‚îú‚îÄ‚îÄ NPCC Publications: 30 docs ‚úÖ
‚îî‚îÄ‚îÄ UK Legislation: 10 docs ‚úÖ

(No "Other" or "Uncategorized" category!)
```

---

## Key Features

### 1. Enhanced Filtering
- **Before:** `.folder` files counted in statistics
- **After:** System files automatically excluded

### 2. Better Logging
- **Before:** Silent failures for uncategorized files
- **After:** Warning logs show exact filenames: `‚ö†Ô∏è  Document without folder prefix found: old-file.pdf`

### 3. Cleanup Utility
- **GET `/api/cleanup_uncategorized`** - Safe dry run, lists files
- **POST `/api/cleanup_uncategorized`** - Deletes uncategorized files
- **Built-in Safety:** Dry run by default, system files protected

---

## Safety & Rollback

### Safety Features
- ‚úÖ No breaking changes - safe to deploy over v2.6.0
- ‚úÖ Backward compatible with existing storage
- ‚úÖ Cleanup is optional (you don't have to use it)
- ‚úÖ Dry run by default (prevents accidental deletion)
- ‚úÖ System files protected (never deletes critical files)

### Rollback to v2.6.0
```bash
cp archive/v2.6.0-deployment.zip .
az functionapp deployment source config-zip \
  --resource-group $RESOURCE_GROUP \
  --name $FUNCTION_APP \
  --src v2.6.0-deployment.zip \
  --subscription $SUBSCRIPTION_ID \
  --timeout 300
```

---

## Files You Can Reference

1. **QUICK-DEPLOY-v2.7.0.md** - Quick copy-paste commands
2. **DEPLOYMENT-v2.7.0.md** - Complete deployment guide with troubleshooting
3. **CLEANUP-GUIDE.md** - Detailed cleanup utility documentation
4. **VERSION-TRACKING.md** - Full version history and changes
5. **CHANGELOG.md** - Technical change log

---

## Technical Details

### Code Changes

**Line 983** - Enhanced file filtering:
```python
# Before
if name and name not in ['document_hashes.json', 'crawl_history.json']:

# After
if name and name not in ['document_hashes.json', 'crawl_history.json'] and not name.endswith('/.folder'):
```

**Lines 1126-1136** - Better categorization:
```python
# Before
else:
    site_folder = "other"

# After
else:
    logging.warning(f'‚ö†Ô∏è  Document without folder prefix found: {blob["name"]}')
    site_folder = "uncategorized"
    display_name = "Uncategorized (Legacy)"
```

**Lines 945-1054** - New cleanup utility function:
```python
def delete_uncategorized_documents(storage_account, container, dry_run=True):
    """Delete documents without folder prefix (uncategorized documents)"""
    # Lists or deletes files without '/' in the name
    # Built-in safety: dry_run by default, system files protected
```

### New API Endpoint

**GET `/api/cleanup_uncategorized`**
- Lists uncategorized documents (dry run - safe)
- Shows count, file names, and total size
- No changes made to storage

**POST `/api/cleanup_uncategorized`**
- Request body: `{"dry_run": false}` to actually delete
- Deletes documents without folder structure
- Returns list of deleted files and any failures
- Deleted documents re-downloaded on next crawl

---

## FAQ

**Q: Will deploying v2.7.0 fix the "Other" category immediately?**  
A: It will properly label it as "Uncategorized (Legacy)" and log warnings. To remove it completely, use the cleanup utility.

**Q: Do I have to use the cleanup utility?**  
A: No, it's optional. The dashboard will still work correctly without it.

**Q: What happens to deleted documents?**  
A: They're re-downloaded from source websites on the next scheduled crawl with proper folder structure.

**Q: Is cleanup safe?**  
A: Yes! Dry run by default, system files protected, detailed logging, and documents can be re-downloaded.

**Q: Can I rollback if something goes wrong?**  
A: Yes, rollback to v2.6.0 is simple and safe (see Rollback section above).

**Q: How long until documents are re-downloaded after cleanup?**  
A: Next scheduled crawl (every 4 hours) or trigger manual crawl immediately.

---

## Recommended Workflow

1. ‚úÖ **Deploy v2.7.0** (fixes dashboard accuracy)
2. ‚úÖ **Check dashboard** (verify "Other" is now labeled correctly)
3. ‚úÖ **Review logs** (look for warnings about uncategorized files)
4. ‚ö†Ô∏è **Optional: Run cleanup dry run** (see what would be deleted)
5. ‚ö†Ô∏è **Optional: Delete uncategorized files** (if you want clean dashboard)
6. ‚úÖ **Trigger manual crawl OR wait** (documents re-downloaded with proper structure)
7. ‚úÖ **Verify dashboard** (all documents properly categorized)

---

**Version:** v2.7.0  
**Date:** October 21, 2025  
**Type:** Bug Fix + New Feature  
**Risk Level:** Low ‚¨áÔ∏è  
**Recommended:** Deploy + Use Cleanup Utility

üéØ **Your dashboard will be accurate and clean!**
